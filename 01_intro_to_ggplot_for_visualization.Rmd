---
title: "Introduction to ggplot for Visualization"
Date:  "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

The outline, explanations, and code examples for this workshop are derived from the work found in the [Data Visualization chapter](http://r4ds.had.co.nz/data-visualisation.html) of Hadley Wickham's book entitled [*R for Data Science*](http://r4ds.had.co.nz/).  If you are borrowing or referring to this introduction, please reference the source material for Wickham, as appropriate.  My goal with this document is to create and outline for a two hour workshop.  The intellectual work is clearly that of Wickham and/or Prabhakaran.  Solutions to Wickham's questions can be found in Jeffrey Arnold's [R for Data Science Solutions](https://jrnold.github.io/r4ds-exercise-solutions/).

## Prerequisites

You'll need

- R
- RStudio
- [Tidyverse](https://tidyverse.org/)

This tutorial assumes you already have R and RStudio installed.  Once you have launched RStudio, load the tidyverse super package of libraries:  `library(tidyverse)`.  Since the Tidyverse packages include the ggplot2 package you do not have to load ggplot2 separately.  If the `library(tidyverse)` command gives an error, you probably want to `install.packages("tidyverse")` before attaching the library.  Installation need only be done once.  Attaching the library must be done each time you launch R.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
```


## Basic syntax 

ggplot syntax template is as follows...

``` r
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))

```

- The data argument takes a Tibble (or data frame)
- The Geom_Function is a function to plot your visualization.

    - Some of the most common *geoms* are scatter plots, bar plots, and box plots.  
    - There are numerous geom_functions.  At some point you will want to [browse the well crafted documentation](https://ggplot2.tidyverse.org/reference/index.html).  
    
- The mapping function requires, minimally, the `[aes()](https://ggplot2.tidyverse.org/reference/aes.html)` function.  This enables you to assign assign the variables of your data frame to the appropriate axis in your plot.

Below is a basic example.  The `geom_point()` function generates a scatter plot from the on-board **mpg** tibble, a dataset of fuel economy data compiled by the US government. `displ` and `hwy` are variables in the dataset assigned to the x and y axis.


```{r message=FALSE, warning=FALSE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy))
```


### The Data

As stated above, ggplot takes a tibble (data frame) for input.  More than that, one has to map the variables to the geom (~ axis).  Different *geoms* require different data types.  Knowing the difference between continuous, categorical, and discrete variables as well as how the data structures (factors, vectors, data/time, strings) interacts will be immensely helpful to you.  You can read all about that in Wickham's *R4DS* book.  Meanwhile, let's have a look at the `mpg` data we just visualized.  Look up the on-board dataset in the help:  `?mpg` to learn more about the variables.

```{r}
mpg
```



### Exercies

1. Make a scatter plot of `hwy` vs `cyl`. (Question from [R4DS](http://r4ds.had.co.nz/data-visualisation.html#exercises ) | [Solution](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.2.4.))

## Aesthetics / Tweaking

Wickham notes there are some data points that seem to fall outside the linear trend.  We can alter the levels of the aesthetics to test hypothesis about this.  This is a reference outline for a workshop so we'll talk about this in the workshop.  

```{r echo=FALSE}
ggplot() + 
  geom_point(data = filter(mpg, class == "2seater"), 
             mapping = aes(x = displ, y = hwy),
             color = "blue") +
  geom_point(data = filter(mpg, class != "2seater"), 
             mapping = aes(x = displ, y = hwy),
             color = "orange")


```


### Levels

- An **aethetic** is a visual property of objects in the plot.  For example: **shape**, **color**.

    - See Also: *size*, opacity (*alpha*), *stroke*

- Each property can have different **levels**.  For example some levels of shape are *circle*, *square*, *triangle*.  By adding variables and/or changing the levels of the aesthetics you can change the visual appearance.  The effectiveness of the different aesthetics will vary with the data type.  R will often provide warnings -- suppressed in this tutorial -- depending on the quality of the mapping association.  (Read the warnings and Google for help when you get confused.)

#### Color

Below, map a third variable, `class` variable to the color aesthetic.  

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class))
```

#### Shape

We can change the shape aesthetic in the same way as we changed the color.  Notice, R will only map to six distinct shapes.

```{r message=FALSE, warning=FALSE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```

### Manual vs automatic aethetics

- When variables are set inside the `aes()` the levels are assigned dynamically.
- When the levels are manually set outside the `aes()`, but still inside the `geom_()`, the levels are static and thereby set according to the preference of the person writing the code.  Below see:  `color = "blue"` is outside the aesthetic but inside the geom function.

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy), color = "blue")
```

### Exercises

#### 3.3.1.1 

([Question](http://r4ds.had.co.nz/data-visualisation.html#exercises-1)) Whatâ€™s gone wrong with this code? Why are the points not blue? ([Solution](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.3.1))

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = "blue"))
```

#### 3.3.1.3

Map a continuous variable to color, size, and shape. How do these aesthetics behave differently for categorical vs. continuous variables?  [Solution](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.3.3)

#### 3.3.1.4  

What happens if you map the same variable to multiple aesthetics? [Soluion](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.3.4)

### Aethetics revisited
#### Stroke

Above I noted that there are many different aesthetics including **shape**, **color**, *size*, opacity (*alpha*), and *stroke*.  Let's take a look at `stroke` and note two additional features...

- When using `stroke`, also use `fill`
- `stroke` may not work with every [shape](http://r4ds.had.co.nz/data-visualisation.html#fig:shapes).  Check the help pages for more information

```{r}
ggplot(mtcars, aes(wt, mpg)) +
  geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
```

## Layers

### Regression Line

Like many graphics programs you can built your vector graphics in layers.  For example, add a regression line with `geom_smooth()`

```{r message=FALSE, warning=FALSE}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class)) + 
  geom_smooth(mapping = aes(x = displ, y = hwy))
```


### ggplot R object

To clarify code changes, let's introduce some code changes.  All ggplot plots can be assigned as an R object.  So, for example...

```{r}
hwy_plot <- ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy, color = class))

hwy_plot
```

Now it will be easier to see the code changes.  Building the same layered plot as before, this time you can more easily see the changed code 

```{r message=FALSE, warning=FALSE}
hwy_plot +
  geom_smooth(mapping = aes(x = displ, y = hwy))
```

### Additional Aesthetics

In the next example, notice the regression_line aesthetic still operates the same we.  A third variable can be used to highlight a new level in the aesthetic.  In this case, we'll show different types of regression lines based on the number categorical `drv` variable

```{r message=FALSE, warning=FALSE}
hwy_plot +
  geom_smooth(mapping = aes(x = displ, y = hwy, linetype = drv))
```

### Standard Error

Since each geom can have it's unique arguments, consult the documentation to learn how to manipulate the appearance.  Here we can consult `?geom_smooth` and learn how to remove the standard error shading, setting `se = FALSE`.   

```{r message=FALSE, warning=FALSE}
hwy_plot +
  geom_smooth(mapping = aes(x = displ, y = hwy, linetype = drv), se = FALSE)
```

### Exercises

http://r4ds.had.co.nz/data-visualisation.html#exercises-3

#### 3.6.1.5  

Will these two graphs look different? Why/why not?  [Solution](http://r4ds.had.co.nz/data-visualisation.html#exercises-3)

``` r
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point() + 
  geom_smooth()

ggplot() + 
  geom_point(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_smooth(data = mpg, mapping = aes(x = displ, y = hwy))

```
#### 3.6.1.6

Recreate the R code necessary to generate the graphs found at [3.6.1.6](http://r4ds.had.co.nz/data-visualisation.html#exercises-3) | [Solutions](https://jrnold.github.io/r4ds-exercise-solutions/data-visualisation.html#exercise-3.6.6)

## Facets

### facet_wrap

facet a plot on a single discrete variable, e.g. the `class` variable that categorically identifies the type of automobile (e.g. compact, midsize, minivan, etc.)

```{r}
hwy_plot +
  facet_wrap(~ class, nrow = 2)
```

### facet_grid

facet a plot on two variables

```{r}
hwy_plot +
  facet_grid(drv ~ cyl)
```


## Statistical Transformations

Some geoms can perform statistical transformations by calculating summary totals for categories.  I find it more logical to use some `dplyr` and `forcats` to generate summary tables but this has to be handled in a special manner when piping to ggplot.  On the other hand, summarizing totals is a convenient default in ggplot for particular geoms.  Importantly, you need to know how which geom and argument to use for your desired outcome.  

### Bar Plot

In the next sets of examples we will use the on-board dataset, *diamonds*.  Diamonds is a dataset covering various characteristics of the precious gem. You can get help on *diamonds*: `?diamonds`  

#### Automtic Categorization (totallying the raw numbers)

`geom_bar` & `stat_count` can generally be used interchangeably

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut))

ggplot(data = diamonds) + 
  stat_count(mapping = aes(x = cut))
```


#### Overriding the default

##### identity ("as is")

```{r}
diamonds %>%
  count(cut) %>% 
  ggplot() +
  geom_bar(mapping = aes(x = cut, y = n), stat = "identity")
  
```


##### Proportion

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut, y = ..prop.., group = 1))
```

#### Fill color

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut, fill = cut))
```


#### Stacked

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut, fill = clarity))
```

#### Side by Side (dodge)

```{r}
ggplot(data = diamonds) + 
  geom_bar(mapping = aes(x = cut, fill = clarity), position = "dodge")
```

## Which type of geom_ ?

The ggplot2 cheat sheet -- available from the **H**elp menu inside RStudio can help you biging to choose the appropriate geom for your data.

## Jitter

`jitter` can help solve the problem of **overplotting**, as can `dodge` discussed above.

```{r}
ggplot(data = mpg) + 
  geom_point(mapping = aes(x = displ, y = hwy), position = "jitter")
```


## Coordinate System 

### Flip

```{r}
mpg %>% 
  mutate(class = class %>% fct_infreq() %>% fct_rev()) %>% 
  ggplot(aes(class)) +
  geom_bar() + coord_flip()

mpg %>% 
  mutate(class = class %>% fct_infreq()) %>% 
  ggplot(aes(class)) +
  geom_bar() 
```


### Mapping

Mapping and GIS is supported quite well using `ggplot` combined with the `sf` GIS package.  Interactive maps can also be generated. (You may want to investigate the `mapbox` and `leaflet` packages.)  If you're new to GIS I encourage you to learn more from the [Mapping in R](https://rfun.library.duke.edu/map/) resource page.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
demo(nc, ask = FALSE, echo = FALSE)

triangle <- nc %>% 
  filter(NAME == "Durham" |
           NAME == "Orange" | 
           NAME == "Wake")

tri_roid <- st_centroid(triangle)

triangle <- cbind(triangle, st_coordinates(tri_roid))

ggplot() +
  geom_sf(data = nc) +
  geom_sf(data = triangle, aes(fill = NAME)) +
  coord_sf(xlim = c(-78, -80), ylim = c(35.2,36.6)) +
  geom_text(data = triangle, aes(label = NAME, x = X, y = Y), size = 3) +
  theme(legend.position = "none", 
        panel.background = element_rect(fill = "transparent"), 
        panel.grid.major = element_line(color = "transparent"), 
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  ylab("") +
  xlab("") +
  ggtitle("Triangle Counties in North Carolina")
```

## Color Scales

`ggplot` offers several carefully default scales and scales can be used to tweak more than color.   The *Scales* section of the *Graphics for Communication* chapter ([R4DS](http://r4ds.had.co.nz/graphics-for-communication.html)) should be read for understanding.  You can tweak the aesthetics for continuous, discrete, datetime, or date variables.  As noted, scales are not always about color. (Scales are also used to change axes breaks, labels and legends.)  

**Color scales are often changed to improve visual clarity.**  Two of the most common packages for this are the `RColorBrewer` and `viridis` packages.  Below the RColorBrewer option is set using the "Dark2" palette on the categorical `mpg$class` variable.  Aside from "Dark2", find the names of other ColorBrewer palette names in many places: `?scale_colour_brewer`, Google, R4DS, etc.

```{r}
hwy_plot +
  scale_color_brewer(palette = "Dark2")  

```

Viridis may work better for continuous variables, rather than discrete.  However, below is an example of the viridis package changing the color scale.

```{r}
hwy_plot +
  viridis::scale_color_viridis(discrete=TRUE)
```

Below is another example this time using a continuous variable, `diamonds$price` to demonstrate  color.  The first plot uses the ggplot default.  The second plot uses the viridis package to override the default.

```{r}
ggplot(data = diamonds) +
  geom_point(mapping = aes(x = carat, y = price, color = price))

ggplot(data = diamonds) +
  geom_point(mapping = aes(x = carat, y = price, color = price)) +
  viridis::scale_color_viridis()
```

## Legends

You can alter the position or existence of legends.  Positions include "top, bottom, left, right, and none".  

```{r}
hwy_plot +
  theme(legend.position = "top")
```

You can control other aspects of the legend's appearance as well.  Here we control the number of rows displayed with `guide_legend(nrow =1)`

```{r}
hwy_plot +
  theme(legend.position = "top") +
  guides(color = guide_legend(nrow = 1))
```


## Labels:  Axis / Markers / Ticks

### Titles, Subtiles, and Captions

```{r}
hwy_plot +
  labs(
    title = "Fuel Efficiency Ratings",
    subtitle = "Highway mpg as a dependency of Engine Displacement",
    caption = "Data from www.fueleconomy.gov"
  )
```

### Axis & Legend Titles

```{r}
hwy_plot +
  labs(
    x = "Engine displacement (L)",
    y = "Highway fuel economy (mpg)",
    colour = "Car type"
    )
```

### Axis ticks & Breaks

Suppose you want the y axis to be listed in increments of 5 rather than the default.  See below.  **Alternatively, remove the axis lables** with code such as:  

- `scale_x_continuous(labels = NULL)`
- `scale_y_continuous(labels = NULL)`

```{r}
hwy_plot +
  scale_y_continuous(breaks = seq(15, 40, by = 5)) 
```


## Annotations

While Annotations can help you highlight your data story, the execution of the annotation is a bit persnickety.  *R4DS* recommends the following approach which accommodates requirements for the same x & y variables.  This requirement for sameness in data frame will help draw axes scales within expected limits.  Trust me, it's best to follow the format here.

```{r message=FALSE, warning=FALSE}
annotation <- mpg %>%
  summarise(
    displ = max(displ),
    hwy = max(hwy),
    label_text = "Average fuel economy skews higher when\nincluding light-weight two-seater sports cars."
  )

ggplot(data = mpg, aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color = class)) +
  geom_text(aes(label = label_text), 
            data = annotation, 
            vjust = "top", hjust = "right",
            color = "coral1") 
```

### Just for Fun

Let's attempt to make the story clearer by adding regression lines.

```{r message=FALSE, warning=FALSE}
ggplot(data = mpg, aes(x = displ, y = hwy)) + 
  geom_point(mapping = aes(color = class)) +
  geom_text(aes(label = label_text), 
            data = annotation, 
            vjust = "top", hjust = "right",
            color = "coral1") +
  geom_smooth(data = mpg %>% filter(class != "2seater"),
              se = TRUE) +
  geom_smooth(data = mpg, color = "coral1", se = FALSE, linetype = 2) +
  labs(
    title = "Fuel Efficiency Ratings",
    subtitle = "Dashed line for all car types, Solid line excludes 2seater class",
    caption = "Data from www.fueleconomy.gov"
  ) 
```


## Themes

Using the `theme()` function, you can customize your visualization extensively.  Above, in the **Legends** section we used `theme()` to selectively move the position of the legend.  Beyond that you can alter the appearance of your visualization with several pre-configured themes (See image from the **R4DS** book, below.)  A fuller explanation of themes can be found in *Graphics for communication* chapter of *R for Data Science* by Hadley Wickham. If you like to tweedle, `themes()` is a great function to explore further.  

![](http://r4ds.had.co.nz/images/visualization-themes.png)


```{r}
hwy_plot +
  theme_bw()
```


### Gridlines

Many people ask about removing gridlines.  At this point let's just say it's easy and there's plenty of documentation on how to do it (e.g. Google, stack exchange, etc.).  The one exception to basic gridline management is when using geom_sf.  See the **Mapping* example above for some rather obscure documentation on how to handle gridlines and axis with `geom_sf()`.


## Saving

`ggsave()` will save your existing visualization to disk.  **However**, when you compose your code using  R Markdown (and `knitr`), you can knit your literate code and integrate your dynamically produced visualizations into your reports, all without separately saving your image to disk.  Read more about [R Markdown](http://r4ds.had.co.nz/r-markdown.html) or browse the [R Markdown support pages](https://rmarkdown.rstudio.com/).

## Extra cool and special extenting packages

- `RColorBrewer` -- highly visible color palettes
- `viridis` -- like `RColorBrewer`, this is a color scale tool especially tuned to visibility issues for for continuous data
- `ggrepel` -- adjust labels to prevent overlap
- **Annimation**:  use `gganimate`to [animate](https://github.com/thomasp85/gganimate) plots with motion
- **Interactivity**:  use `plotly` to turn your visualization into an interactive, publication-quality, online experience
- Gallery of other extra cool [ggplot extensions](http://www.ggplot2-exts.org/gallery/)

## Resources

- R for Data Science by Hadley Wickham.  Chapter on _Data Visualization_,  & Chapter on _Graphics for Communication_, & Chapter on _Exploratory Data Analysis_
- Intro, Tutorials, and Reference materials by Selva Prabhakaran
- ggplot cookbook 
- [Data Visualization](http://socviz.co/): A practical introduction by Kieran Healy
- [Fundamentals of Data Visualization](https://serialmentor.com/dataviz/) by Claus O. Wilke


## devtools::session_info

List the packages used to develop this code

```{r}
devtools::session_info()
```


## Shareable 

Shareable via Creative Commons: [CC-BY-NC](https://creativecommons.org/licenses/by-nc/4.0/) -- Attribution, Non-Commercial

![](images/by-nc.png)



